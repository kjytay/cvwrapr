<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to `kfoldcv` • cvwrapr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to `kfoldcv`">
<meta property="og:description" content="cvwrapr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cvwrapr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/computeError.html">Using `computeError`</a>
    </li>
    <li>
      <a href="../articles/kfoldcv.html">Introduction to `kfoldcv`</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="kfoldcv_files/header-attrs-2.6/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to <code>kfoldcv</code>
</h1>
            
      
      
      <div class="hidden name"><code>kfoldcv.Rmd</code></div>

    </div>

    
    
<p>The main function in the <code>cvwrapr</code> package is <code>kfoldcv</code> which performs K-fold cross-validation (CV). In this vignette, we go through a series of examples showing how it can be used.</p>
<div id="examples" class="section level2">
<h2 class="hasAnchor">
<a href="#examples" class="anchor"></a>Examples</h2>
<div id="vanilla-glmnet" class="section level3">
<h3 class="hasAnchor">
<a href="#vanilla-glmnet" class="anchor"></a>Vanilla <code>glmnet</code>
</h3>
<p>Let’s set up some fake data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">nobs</span> <span class="op">&lt;-</span> <span class="fl">100</span>; <span class="va">nvars</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nobs</span> <span class="op">*</span> <span class="va">nvars</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nobs</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nobs</span><span class="op">)</span></code></pre></div>
<p>If we used <code>glmnet</code>’s <code>cv.glmnet</code> function to perform CV, the call would look like this:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://glmnet.stanford.edu">glmnet</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">glmnet_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/cv.glmnet.html">cv.glmnet</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></code></pre></div>
<p>An equivalent call using <code>kfoldcv</code> would look like this.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">cvwrapr</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">cv_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfoldcv.html">kfoldcv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, train_fun <span class="op">=</span> <span class="va">glmnet</span>, predict_fun <span class="op">=</span> <span class="va">predict</span><span class="op">)</span></code></pre></div>
<p>Apart from <code>x</code> and <code>y</code>, <code>kfoldcv</code> needs <code>train_fun</code> and <code>predict_fun</code> which are the training and prediction functions respectively.</p>
<p>The returned objects from <code>kfoldcv</code> and <code>cv.glmnet</code> are slightly different:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">)</span>
<span class="co">#&gt;  [1] "lambda"     "cvm"        "cvsd"       "cvup"       "cvlo"      </span>
<span class="co">#&gt;  [6] "nzero"      "call"       "name"       "glmnet.fit" "lambda.min"</span>
<span class="co">#&gt; [11] "lambda.1se" "index"</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">cv_fit</span><span class="op">)</span>
<span class="co">#&gt;  [1] "lambda"     "cvm"        "cvsd"       "cvup"       "cvlo"      </span>
<span class="co">#&gt;  [6] "lambda.min" "lambda.1se" "index"      "name"       "overallfit"</span></code></pre></div>
<p>Importantly though, the CV computations are the same:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://testthat.r-lib.org">testthat</a></span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">lambda</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">cvm</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cvm</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">cvsd</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cvsd</span><span class="op">)</span></code></pre></div>
</div>
<div id="glmnet-with-function-arguments" class="section level3">
<h3 class="hasAnchor">
<a href="#glmnet-with-function-arguments" class="anchor"></a><code>glmnet</code> with function arguments</h3>
<p><code>kfoldcv</code> works with more complicated function calls as well. For example, let’s say we want to fit a binomial model with observation weights:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">biny</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>
<span class="va">weights</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, length.out <span class="op">=</span> <span class="va">nobs</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">glmnet_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/cv.glmnet.html">cv.glmnet</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">biny</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></code></pre></div>
<p>Here is the equivalent call with <code>kfoldcv</code>. We now have 3 extra parameters:</p>
<ol style="list-style-type: decimal">
<li>
<code>train_params</code>: A list of function arguments to be passed to <code>train_fun</code> for model-fitting (excluding the data matrix <code>x</code> and the response <code>y</code>).</li>
<li>
<code>predict_params</code>: A list of function arguments to be passed to <code>predict_fun</code> for prediction (excluding the fitted model <code>object</code>, new data matrix <code>newx</code> and the lambda sequence <code>s</code>). Notice here that we had to pass <code>type = "response"</code> to the prediction function: this is because <code>glmnet</code> returns the linear predictor by default, whereas <code>kfoldcv</code> expects the predictions to be on the scale of the response variable.</li>
<li>
<code>train_row_params</code>: A vector of names of function arguments that should be subsetted when performing CV.</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">cv_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfoldcv.html">kfoldcv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">biny</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,
                    train_fun <span class="op">=</span> <span class="va">glmnet</span>, predict_fun <span class="op">=</span> <span class="va">predict</span>,
                    train_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"binomial"</span>,
                                        weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span>,
                    predict_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>,
                    train_row_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"weights"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Again, the CV computations are the same:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">lambda</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">cvm</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cvm</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">cvsd</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cvsd</span><span class="op">)</span></code></pre></div>
</div>
<div id="glmnet-with-exclude" class="section level3">
<h3 class="hasAnchor">
<a href="#glmnet-with-exclude" class="anchor"></a><code>glmnet</code> with exclude</h3>
<p>Let’s look at a <code>glmnet</code> example with <code>exclude</code>. First, let’s create some data such that the <code>x</code> matrix is sparse:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span>
<span class="va">x</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>, <span class="fl">4</span> <span class="op">*</span> <span class="va">nobs</span> <span class="op">*</span> <span class="va">nvars</span> <span class="op">/</span> <span class="fl">5</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nobs</span><span class="op">)</span></code></pre></div>
<p>Sometimes, we might want to exclude variables which are too sparse. In the code below, we exclude variables that are more than 80% sparse. Note that we are passing a function to the <code>exclude</code> argument, functionality that is only available in <code>glmnet</code> version 4.1-2 and later.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">filter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.8</span><span class="op">)</span>

<span class="va">foldid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, length <span class="op">=</span> <span class="va">nobs</span><span class="op">)</span><span class="op">)</span>
<span class="va">glmnet_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/cv.glmnet.html">cv.glmnet</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, foldid <span class="op">=</span> <span class="va">foldid</span>, exclude <span class="op">=</span> <span class="va">filter</span><span class="op">)</span></code></pre></div>
<p>Of course, we could pass the filter along to <code>kfoldcv</code> via <code>train_params</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">cv_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfoldcv.html">kfoldcv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, train_fun <span class="op">=</span> <span class="va">glmnet</span>, predict_fun <span class="op">=</span> <span class="va">predict</span>,
                  train_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>exclude <span class="op">=</span> <span class="va">filter</span><span class="op">)</span>, foldid <span class="op">=</span> <span class="va">foldid</span><span class="op">)</span>

<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">lambda</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">cvm</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cvm</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">cvsd</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cvsd</span><span class="op">)</span></code></pre></div>
<p>If we have an earlier version of <code>glmnet</code> which only allows the <code>exclude</code> argument to take a vector of indices, we can use <code>kfoldcv</code> to achieve the same result:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">train_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">exclude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colSums.html">colMeans</a></span><span class="op">(</span><span class="va">x</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0.8</span><span class="op">)</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">exclude</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/glmnet.html">glmnet</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/glmnet.html">glmnet</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="op">-</span><span class="va">exclude</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, <span class="va">y</span><span class="op">)</span>
  <span class="op">}</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="va">model</span><span class="op">$</span><span class="va">lambda</span>,
              exclude <span class="op">=</span> <span class="va">exclude</span>,
              model <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">predict_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newx</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">exclude</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">model</span>, newx <span class="op">=</span> <span class="va">newx</span>, s <span class="op">=</span> <span class="va">s</span><span class="op">)</span>
  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">model</span>, newx <span class="op">=</span> <span class="va">newx</span><span class="op">[</span>, <span class="op">-</span><span class="va">object</span><span class="op">$</span><span class="va">exclude</span>, drop <span class="op">=</span> <span class="cn">FALSE</span><span class="op">]</span>, s <span class="op">=</span> <span class="va">s</span><span class="op">)</span>
  <span class="op">}</span>
<span class="op">}</span>

<span class="va">cv_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfoldcv.html">kfoldcv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, train_fun <span class="op">=</span> <span class="va">train_fun</span>, predict_fun <span class="op">=</span> <span class="va">predict_fun</span>,
                  foldid <span class="op">=</span> <span class="va">foldid</span><span class="op">)</span>

<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">lambda</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">cvm</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cvm</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">cvsd</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cvsd</span><span class="op">)</span></code></pre></div>
<p>Some notes of caution are in order:</p>
<ol style="list-style-type: decimal">
<li>
<code>train_fun</code> must take in the design matrix as <code>x</code> and the response as <code>y</code>. In its return value, it must have the <code>lambda</code> sequence as the named element <code>lambda</code>.</li>
<li>
<code>predict_fun</code> must take in the output of <code>train_fun</code> as <code>object</code> and the new data matrix as <code>newx</code>. It must also have an argument (<code>s</code> by default) that takes in a <code>lambda</code> sequence, and <code>predict_fun</code> must return a matrix of predictions, each column corresponding to one value of <code>lambda</code>.</li>
</ol>
</div>
<div id="other-loss-functions" class="section level3">
<h3 class="hasAnchor">
<a href="#other-loss-functions" class="anchor"></a>Other loss functions</h3>
<p>The loss function used in CV is controlled by two function arguments: <code>type.measure</code> and <code>family</code>. To see all possible <code>type.measure</code> values for each family, run <code><a href="../reference/availableTypeMeasures.html">availableTypeMeasures()</a></code>:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/availableTypeMeasures.html">availableTypeMeasures</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">#&gt; $gaussian</span>
<span class="co">#&gt; [1] "deviance" "mse"      "mae"     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $binomial</span>
<span class="co">#&gt; [1] "deviance" "class"    "auc"      "mse"      "mae"     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $poisson</span>
<span class="co">#&gt; [1] "deviance" "mse"      "mae"     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $cox</span>
<span class="co">#&gt; [1] "deviance" "C"       </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $multinomial</span>
<span class="co">#&gt; [1] "deviance" "class"    "mse"      "mae"     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $mgaussian</span>
<span class="co">#&gt; [1] "deviance" "mse"      "mae"     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; $GLM</span>
<span class="co">#&gt; [1] "deviance" "mse"      "mae"</span></code></pre></div>
<p>The default is <code>type.measure = "deviance"</code> and <code>family = "gaussian"</code>, which corresponds to mean-squared error. Below is an example of misclassification loss with a binary response:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">biny</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span><span class="op">(</span><span class="va">y</span> <span class="op">&gt;</span> <span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>

<span class="va">glmnet_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://glmnet.stanford.edu/reference/cv.glmnet.html">cv.glmnet</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">biny</span>, family <span class="op">=</span> <span class="st">"binomial"</span>,
                        type.measure <span class="op">=</span> <span class="st">"class"</span>, foldid <span class="op">=</span> <span class="va">foldid</span><span class="op">)</span>
<span class="va">cv_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfoldcv.html">kfoldcv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">biny</span>, family <span class="op">=</span> <span class="st">"binomial"</span>, type.measure <span class="op">=</span> <span class="st">"class"</span>,
                  train_fun <span class="op">=</span> <span class="va">glmnet</span>, predict_fun <span class="op">=</span> <span class="va">predict</span>,
                  train_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span>,
                  predict_params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span>,
                  foldid <span class="op">=</span> <span class="va">foldid</span><span class="op">)</span>
  
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">lambda</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">cvm</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cvm</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">glmnet_fit</span><span class="op">$</span><span class="va">cvsd</span>, <span class="va">cv_fit</span><span class="op">$</span><span class="va">cvsd</span><span class="op">)</span></code></pre></div>
<p>There seems to be a bit of duplication in that we have to specify <code>family = "binomial"</code> as an argument to <code><a href="../reference/kfoldcv.html">kfoldcv()</a></code> as well as in the list provided to <code>train_params</code>. This duplication is to allow for greater generality for <code>train_fun</code>. In <code>glmnet</code>, the type of model being fit is defined by an argument named <code>family</code>, so in theory we could extract the <code>family</code> value from <code>train_params</code> to determine the type of model being fit. However, not all model-fitting functions will have a “family” argument.</p>
</div>
<div id="principal-components-pc-regression" class="section level3">
<h3 class="hasAnchor">
<a href="#principal-components-pc-regression" class="anchor"></a>Principal-components (PC) regression</h3>
<p>Let’s look at a non-<code>glmnet</code> example. Here, I want to do principal components (PC) regression and I want to cross-validate the number of PCs to include in the model. Let’s use our non-sparse fake data again:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">nobs</span> <span class="op">&lt;-</span> <span class="fl">100</span>; <span class="va">nvars</span> <span class="op">&lt;-</span> <span class="fl">10</span>
<span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nobs</span> <span class="op">*</span> <span class="va">nvars</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="va">nobs</span><span class="op">)</span>
<span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html">rowSums</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">rnorm</a></span><span class="op">(</span><span class="va">nobs</span><span class="op">)</span></code></pre></div>
<p>The <code>pls</code> package can perform PC regression with <code><a href="https://rdrr.io/pkg/pls/man/mvr.html">pcr()</a></code>, but its interface is quite different from what <code><a href="../reference/kfoldcv.html">kfoldcv()</a></code> needs. Recall that <code>train_fun</code> must take the data matrix, response and hyperparameter values as <code>x</code>, <code>y</code> and <code>lambda</code> respectively. <code>predict_fun</code> must take the output of <code>train_fun</code>, the new data matrix and the hyperparameter values as <code>object</code>, <code>newx</code> and <code>s</code> respectively. The code below shows how we can write <code>train_fun</code> and <code>predict_fun</code> for the PC regression problem:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://mevik.net/work/software/pls.html">pls</a></span><span class="op">)</span>

<span class="co"># lambda represents no. of PCs</span>
<span class="va">train_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">lambda</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">pls</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pls/man/mvr.html">pcr</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">df</span>, ncomp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="va">lambda</span>, model <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">predict_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newx</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="va">newx</span>, ncomp <span class="op">=</span> <span class="va">s</span><span class="op">)</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="va">preds</span>,
               dim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">newx</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>
<span class="va">cv_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfoldcv.html">kfoldcv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, 
                  train_fun <span class="op">=</span> <span class="va">train_fun</span>, predict_fun <span class="op">=</span> <span class="va">predict_fun</span><span class="op">)</span></code></pre></div>
<p><code><a href="../reference/kfoldcv.html">kfoldcv()</a></code> returns an object of class “cv_obj”, which is equipped with a <code>plot</code> method much like those for <code>cv.glmnet</code> objects. The code below shows how we might plot a CV curve for PC regression:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cv_fit</span>, log.lambda <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
<p><img src="kfoldcv_files/figure-html/unnamed-chunk-18-1.png" width="672"></p>
<p>Notice that in determining the <code>lambda.1se</code> value, the <code>plot</code> method correctly determined that it should be looking at smaller values of <code>lambda</code> (corresponding to fewer PCs), instead of larger values of <code>lambda</code>, as is usually the case in <code>glmnet</code>. How did it figure it out? When computing the <code>lambda.1se</code> value, <code>kfoldcv</code> looks for the smallest model such that its CV error is within 1 SE of the minimum CV error. In doing so, it assumes that the <code>lambda</code> sequence provided to it is ordered from smallest model to largest model. In this example, we provided <code>lambda &lt;- 1:10</code>. Compare that to the <code>glmnet</code> examples, where <code>lambda</code> is ordered from largest to smallest.</p>
</div>
<div id="gradient-boosting-with-gbm" class="section level3">
<h3 class="hasAnchor">
<a href="#gradient-boosting-with-gbm" class="anchor"></a>Gradient boosting with <code>gbm</code>
</h3>
<p>Let’s look at another non-<code>glmnet</code> example: gradient boosting with the <code>gbm</code> package. In this first example, we want to cross-validate the number of trees to be included in our boosting ensemble. As with PC regression, we need to write our own <code>train_fun</code> and <code>predict_fun</code> to interface correctly with <code>kfoldcv</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/gbm-developers/gbm">gbm</a></span><span class="op">)</span>

<span class="co"># lambda represents # of trees</span>
<span class="va">train_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">lambda</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">gbm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gbm/man/gbm.html">gbm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">df</span>, n.trees <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">lambda</span><span class="op">)</span>,
                    distribution <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="va">lambda</span>, model <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">predict_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newx</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">newdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">newx</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">model</span>, newdata <span class="op">=</span> <span class="va">newdf</span>, n.trees <span class="op">=</span> <span class="va">s</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span>
<span class="va">cv_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfoldcv.html">kfoldcv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, 
                  train_fun <span class="op">=</span> <span class="va">train_fun</span>, predict_fun <span class="op">=</span> <span class="va">predict_fun</span><span class="op">)</span></code></pre></div>
<p>Again, we can plot a CV curve. Notice how we can rename the x-axis and add a title:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cv_fit</span>, log.lambda <span class="op">=</span> <span class="cn">FALSE</span>, xlab <span class="op">=</span> <span class="st">"No. of trees"</span>, 
     main <span class="op">=</span> <span class="st">"CV MSE vs. no. of trees"</span><span class="op">)</span></code></pre></div>
<p><img src="kfoldcv_files/figure-html/unnamed-chunk-20-1.png" width="672"></p>
<p>Next, let’s try to cross-validate for a different parameter: <code>interaction.depth</code>. Notice that the internals of <code>train_fun</code> and <code>predict_fun</code> look quite different from before. This is because <code>gbm</code> has the ability to predict for any number of trees as long as it is smaller than that in the fitted model: this allows us to fit just one model for the whole <code>lambda</code> sequence. For <code>interaction.depth</code>, we will have to fit one model for each <code>interaction.depth</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># lambda represents interaction depth</span>
<span class="va">train_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">lambda</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span>
  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">lambda</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu">gbm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/gbm/man/gbm.html">gbm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">df</span>, 
                                               interaction.depth <span class="op">=</span> <span class="va">i</span>,
                                               distribution <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>lambda <span class="op">=</span> <span class="va">lambda</span>, model <span class="op">=</span> <span class="va">model</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="va">predict_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newx</span>, <span class="va">s</span><span class="op">)</span> <span class="op">{</span>
  <span class="va">newdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">newx</span><span class="op">)</span>
  <span class="va">preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">object</span><span class="op">$</span><span class="va">model</span>,
                  <span class="kw">function</span><span class="op">(</span><span class="va">obj</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">obj</span>, newdata <span class="op">=</span> <span class="va">newdf</span>, 
                                        n.trees <span class="op">=</span> <span class="va">obj</span><span class="op">$</span><span class="va">n.trees</span><span class="op">)</span><span class="op">)</span>
  
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">preds</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">newdf</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="va">lambda</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span>
<span class="va">cv_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfoldcv.html">kfoldcv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, lambda <span class="op">=</span> <span class="va">lambda</span>, 
                  train_fun <span class="op">=</span> <span class="va">train_fun</span>, predict_fun <span class="op">=</span> <span class="va">predict_fun</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">cv_fit</span>, log.lambda <span class="op">=</span> <span class="cn">FALSE</span>, xlab <span class="op">=</span> <span class="st">"Interaction depth"</span>, 
     main <span class="op">=</span> <span class="st">"CV MSE vs. interaction depth"</span><span class="op">)</span></code></pre></div>
<p><img src="kfoldcv_files/figure-html/unnamed-chunk-21-1.png" width="672"></p>
</div>
</div>
<div id="other-functionality-for-kfoldcv" class="section level2">
<h2 class="hasAnchor">
<a href="#other-functionality-for-kfoldcv" class="anchor"></a>Other functionality for <code>kfoldcv</code>
</h2>
<p><code>kfoldcv</code> has a few other capabilities worth mentioning here:</p>
<ul>
<li>
<code>foldid</code>: An optional vector of values between <code>1</code> and <code>nfolds</code> (inclusive) identifying which fold each observation is in. Note that <code>kfoldcv</code> actually works even if <code>foldid</code> does not take values between <code>1</code> and <code>nfolds</code>, but for ease of use it is recommended that users do so.</li>
<li>
<code>keep</code>: If set to <code>TRUE</code>, <code>kfoldcv</code> returns the matrix of pre-validated fits as well as the <code>foldid</code> vector used in CV. Default is <code>FALSE</code>.</li>
<li>
<code>save_cvfits</code>: If set to <code>TRUE</code>, <code>kfoldcv</code> returns the intermediate model fits for each CV fold. This is useful if the user wants to inspect the intermediate fits (e.g model coefficients) or compute some intermediate statistic (e.g. how many times a feature appears across the folds). However, bear in mind that this could greatly inflate the size of the object <code>kfoldcv</code> returns. Default is <code>FALSE</code>.</li>
<li>
<code>parallel</code>: If set to <code>TRUE</code>, model-fitting for each CV fold can be done in parallel. A parallel backend must be registered first. Below is a code example comparing a call to <code>kfoldcv</code> with and without parallel computing, using the vanilla <code>glmnet</code> example.</li>
</ul>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># without parallel computing</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span>
<span class="va">foldid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">5</span>, length.out <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">cv_fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfoldcv.html">kfoldcv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, foldid <span class="op">=</span> <span class="va">foldid</span>, train_fun <span class="op">=</span> <span class="va">glmnet</span>, 
                   predict_fun <span class="op">=</span> <span class="va">predict</span><span class="op">)</span>

<span class="co"># with parallel computing</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">parallel</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">doParallel</span><span class="op">)</span>
<span class="va">cl</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">makeCluster</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>
<span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>
<span class="va">cv_fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/kfoldcv.html">kfoldcv</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, foldid <span class="op">=</span> <span class="va">foldid</span>, train_fun <span class="op">=</span> <span class="va">glmnet</span>, 
                   predict_fun <span class="op">=</span> <span class="va">predict</span>, parallel <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/makeCluster.html">stopCluster</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span>

<span class="co"># check that the two fits are the same</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">cv_fit1</span><span class="op">$</span><span class="va">lambda</span>, <span class="va">cv_fit2</span><span class="op">$</span><span class="va">lambda</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">cv_fit1</span><span class="op">$</span><span class="va">cvm</span>, <span class="va">cv_fit2</span><span class="op">$</span><span class="va">cvm</span><span class="op">)</span>
<span class="fu"><a href="https://testthat.r-lib.org/reference/equality-expectations.html">expect_equal</a></span><span class="op">(</span><span class="va">cv_fit1</span><span class="op">$</span><span class="va">cvsd</span>, <span class="va">cv_fit2</span><span class="op">$</span><span class="va">cvsd</span><span class="op">)</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kenneth Tay.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
